# 로드 밸런싱이란?

**로드 밸런싱** 이란 하나의 인터넷 서비스가 발생하는 트래픽이 많을 때 여러 대의 서버가 분산처리하여 서버의 로드율 증가, 부하량, 속도저하 등을 고려하여 적절히 분산처리하여 해결해주는 서비스이고, 로드 밸런싱을 담당하는 장비를 **로드밸런서** 라고 부릅니다.

증가한 트래픽에 대처할 수 있는 방법은 크게 두 가지입니다.

- Scale up : 서버 자체의 성능을 높이는 것
- Scale out : 여러 대의 서버를 두는 것

## 로드 밸런싱의 주요 기술

1. NAT(Network Address Translation)

- private ip를 public ip 주소로 바꾸는 데 사용하는 통신망의 주소 변조기입니다.

2. Tunneling

- 인터넷상에서 눈에 보이지 않는 통로를 만들어 통신할 수 있게 하는 개념
- 데이터를 캡슐화해서 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제할 수 있습니다.

3. DSR(Dynamic Source Routing protocol)

- 로드 밸런서 사용 시 서버에서 클라이언트로 되돌아가는 경우 목적지 주소를 스위치의 IP 주소가 아닌 클라이언트의 IP 주소로 전달해서 네트워크 스위치를 거치지 않고 바로 클라이언트를 찾아가는 개념입니다.

## 로드 밸런서가 서버를 선택하는 방법

1. 라운드로빈 방식(Round Robin Method)

- 서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식입니다. 클라이언트의 요청을 순서대로 분배하기 때문에 여러 대의 서버가 동일한 스펙을 갖고 있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합합니다.

2. 가중 라운드로빈 방식(Weighted Round Robin Method)

- 각각의 서버마다 가중치를 매기고 가중치가 높은 서버에 클라이언트 요청을 우선적으로 배분합니다. 주로 서버의 트래픽 처리 능력이 상이한 경우 사용되는 부하 분산 방식입니다. 예를 들어 A라는 서버가 5라는 가중치를 갖고 B라는 서버가 2라는 가중치를 갖는다면, 로드밸런서는 라운드로빈 방식으로 A 서버에 5개 B 서버에 2개의 요청을 전달합니다.

3. IP 해시 방식(IP Hash Method)

- 클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식입니다. 사용자의 IP를 해싱해(Hashing, 임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑하는 것, 또는 그러한 함수) 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장합니다.

4. 최소 연결 방식(Least Connection Method)

- 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분합니다. 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합한 방식입니다.

5. 최소 리스폰타임(Least Response Time Method)

- 서버의 현재 연결 상태와 응답시간(Response Time, 서버에 요청을 보내고 최초 응답을 받을 때까지 소요되는 시간)을 모두 고려하여 트래픽을 배분합니다. 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분하는 방식입니다.

## 로드 밸런서의 종류

로드밸런서는 OSI 7계층을 기준으로 어떻게 부하를 분산하는지에 따라 종류가 나뉩니다. 2 계층을 기준으로 부하를 분산한다면 L2, 3 계층을 기준으로 부하를 분산한다면 L3인 방식입니다. 상위 계층으로 갈수록 섬세한 부하 분산이 가능하지만 가격이 비싸집니다. 하위 계층으로 갈수록 간단한 부하 분산이 가능하고 가격이 저렴해집니다.

| 로드밸런서 |                       내용                        |      종류      |
| ---------- | :-----------------------------------------------: | :------------: |
| L2         |   Data link 계층을 사용, Mac주소 기반 부하 분산   |                |
| L3         |    Network 계층을 사용, IP주소 기반 부하 분산     |                |
| L4         |    Transport 계층을 사용, Port 기반 부하 분산     |    TCP, UDP    |
| L7         | Application 계층을 사용, 요청(URL) 기반 부하 분산 | HTTP, HTTPS 등 |

**L4 로드밸런서와 L7 로드밸런서가 가장 많이 활용됩니다.**
그 이유는 L4 로드밸런서부터 포트(Port)정보를 바탕으로 로드를 분산하는 것이 가능하기 때문입니다. 한 대의 서버에 각기 다른 포트 번호를 부여하여 다수의 서버 프로그램을 운영하는 경우라면 최소 L4 로드밸런서 이상을 사용해야만 합니다.

**L4 로드밸런서**는 네트워크 계층(IP, IPX)이나 트랜스포트 계층(TCP, UDP)의 정보를 바탕으로 로드를 분산합니다. IP주소나 포트번호, MAC주소, 전송 프로토콜에 따라 트래픽을 나누는 것이 가능합니다.

반면 **L7 로드밸런서**의 경우 애플리케이션 계층(HTTP, FTP, SMTP)에서 로드를 분산하기 때문에 HTTP 헤더, 쿠키 등과 같은 사용자의 요청을 기준으로 특정 서버에 트래픽을 분산하는 것이 가능합니다. 쉽게 말해 패킷의 내용을 확인하고 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능한 것입니다. 위 그림과 같이 URL에 따라 부하를 분산시키거나, HTTP 헤더의 쿠키값에 따라 부하를 분산하는 등 클라이언트의 요청을 보다 세분화해 서버에 전달할 수 있습니다. 또한 L7 로드밸런서의 경우 특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며, DoS/DDoS와 같은 비정상적인 트래픽을 필터링할 수 있어 네트워크 보안 분야에서도 활용되고 있습니다.

## 로드밸런서 장애 대비

1. 로드밸런서를 이중화하여 장애를 대비합니다.

2. 장애가 났을 경우

- 이중화된 Load Balancer들은 서로 Health Check를 합니다.
- Main Load Balancer가 동작하지 않으면 가상IP(VIP, Virtual IP)는 여분의 Load Balancer로 변경됩니다.
- 여분의 Load Balancer로 운영하게 됩니다.

## REFERENCES

https://post.naver.com/viewer/postView.nhn?volumeNo=27046347&memberNo=2521903

https://nesoy.github.io/articles/2018-06/Load-Balancer

https://deveric.tistory.com/91

https://asfirstalways.tistory.com/320
